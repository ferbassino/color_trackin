<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>tracking.js - color with video</title>
    <link rel="stylesheet" href="styles.css" />

    <script src="../build/tracking-min.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.min.js"></script> -->
    <script src="assets/stats.min.js"></script>
    <!-- <script src="assets/color_camera_gui.js"></script> -->
    <script
      src="https://cdn.plot.ly/plotly-2.32.0.min.js"
      charset="utf-8"
    ></script>
    <style>
      .timer {
        font-size: 48px;
        margin-bottom: 20px;
        margin-left: 20px;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="menu">
        <a href="/index.html">Home</a>
        <a href="/white_tracker.html">Upload video</a>
        <a href="/tracking.html">Real Time</a>
        <a href="/white_tracker_analysis.html">Analysis</a>
      </div>
    </nav>

    <div>
      <div class="left">
        <div class="demo-title">
          <p>
            <a href="http://trackingjs.com" target="_parent">tracking.js</a> －
            detect certain colors in a video
          </p>
        </div>
        <div class="container">
          <div class="timer" id="timer">00:00:000</div>
        </div>
        <input type="file" id="fileInput" accept="video/*" />
        <button id="loadButton"></button>
        <button onclick="startTracking()" id="init_buton">analizar</button>
        <button id="stopButton">detener</button>

        <div class="demo-frame">
          <div class="demo-container">
            <div id="rectangle"></div>
            <video id="videoPlayer" preload autoplay muted controls>
              <source id="videoSource" type="video/mp4" />
            </video>
            <canvas id="canvas" width="800" height="800"></canvas>
          </div>
        </div>
        <div class="right">
          <div id="tester" style="width: 800px; height: 800px"></div>
        </div>
      </div>
    </div>

    <script>
      // --------------------- cronometro
      let timerInterval;
      let startTime;
      let running = false;
      const timerDisplay = document.getElementById("timer");
      const startButton = document.getElementById("init_buton");
      const stopButton = document.getElementById("stopButton");
      // ingresamos la calibración
      const pixelEnMetros = 0.0022;
      function startTimer() {
        if (!running) {
          running = true;
          startTime = Date.now();
          timerInterval = setInterval(updateTimer, 10);
        }
      }

      function stopTimer() {
        if (running) {
          running = false;
          clearInterval(timerInterval);
        }
      }

      function updateTimer() {
        const elapsedTime = Date.now() - startTime;

        const minutes = Math.floor(elapsedTime / (1000 * 60))
          .toString()
          .padStart(2, "0");
        const seconds = Math.floor((elapsedTime % (1000 * 60)) / 1000)
          .toString()
          .padStart(2, "0");
        const milliseconds = Math.floor(elapsedTime % 1000)
          .toString()
          .padStart(3, "0");
        timerDisplay.textContent = `${minutes}:${seconds}:${milliseconds}`;
        localStorage.setItem("duration", JSON.stringify(elapsedTime));
      }

      startButton.addEventListener("click", startTimer);
      stopButton.addEventListener("click", stopTimer);

      // -------------------- fin cronometro

      var video = document.getElementById("videoPlayer");

      video.addEventListener("loadedmetadata", function (event) {
        var videoWidth = event.target.videoWidth;
        var videoHeight = event.target.videoHeight;
        // fps = this.duration;

        localStorage.setItem("videoWidth", JSON.stringify(videoWidth));
        localStorage.setItem("videoHeight", JSON.stringify(videoHeight));
      });

      document.addEventListener("DOMContentLoaded", function () {
        const fileInput = document.getElementById("fileInput");
        const loadButton = document.getElementById("loadButton");
        const videoSource = document.getElementById("videoSource");

        // Evento de clic en el botón para cargar el video
        loadButton.addEventListener("click", function () {
          fileInput.click(); // Simular clic en el input de tipo file
        });

        // Evento de cambio en el input de tipo file
        fileInput.addEventListener("change", function () {
          const file = this.files[0];
          if (file) {
            cargarVideo(file);
          }
        });

        // Función para cargar el video y establecer la URL en la etiqueta source
        function cargarVideo(file) {
          const reader = new FileReader();
          reader.onload = function (event) {
            // Generar la URL del archivo cargado
            const videoURL = event.target.result;

            // Establecer la URL en el atributo src de la etiqueta source
            videoSource.src = videoURL;

            // Opcionalmente, cargar automáticamente el video
            const videoPlayer = document.getElementById("videoPlayer");
            videoPlayer.load();
          };
          // Leer el contenido del archivo como una URL de datos (data URL)
          reader.readAsDataURL(file);

          initGUIControllers(tracker);
        }
      });

      const startTracking = () => {
        // ----------frames-----------------------
        var v = document.getElementById("videoPlayer");
        var c = 0; // time of last frame
        var framelength = 1; // length of one frame
        var fps;
        function check(t, m) {
          var diff = Math.abs(m.mediaTime - c); // difference between this frame and the last
          if (diff && diff < framelength) {
            framelength = diff;
            fps = Number((1 / framelength).toFixed(2));
          }
          c = m.mediaTime;
          v.requestVideoFrameCallback(check);
          console.log(fps);
          localStorage.setItem("fps", JSON.stringify(fps));
        }
        v.requestVideoFrameCallback(check);
        // ----------frames-----------------------
        var canvas = document.getElementById("canvas");
        var context = canvas.getContext("2d");

        tracking.ColorTracker.registerColor("white", function (r, g, b) {
          if (r > 200 && g > 200 && b > 200) {
            return true;
          }
          return false;
        });

        var tracker = new tracking.ColorTracker(["white"]);
        tracker.setMinDimension(1);

        const trackingTask = tracking.track("#videoPlayer", tracker);

        trackingTask.run();

        document
          .getElementById("stopButton")
          .addEventListener("click", function () {
            trackingTask.stop();
          });

        // tracking.track("#videoPlayer", tracker);
        const array = [];
        const init = document.getElementById("init_buton");
        let xArray = [];
        let yArray = [];

        let yPositionInnit = 0;
        let yPositionInnitState = false;

        tracker.on("track", function (event) {
          var videoWidth = JSON.parse(localStorage.getItem("videoWidth"));
          var videoHeight = JSON.parse(localStorage.getItem("videoHeight"));
          context.clearRect(0, 0, videoWidth, videoHeight);
          // context.clearRect(0, 0, canvas.width, canvas.height);
          event.data.forEach(function (rect) {
            // capturar primer valor de y
            // if (!yPositionInnitState) {
            //   yPositionInnit = rect.y;
            //   console.log("Primer valor ingresado:", yPositionInnit);
            //   yPositionInnitState = true;
            // }

            // --------------------------

            // if (rect.color === "custom") {
            //   rect.color = tracker.customColor;
            // }

            // xArray.push(rect.x * pixelEnMetros);
            // yArray.push((videoHeight - rect.y) * pixelEnMetros);
            // if (xArray.length > 500) {
            //   xArray.shift();
            //   yArray.shift();
            // }

            // const arrayTime = [];
            // arrayTime.push(Date.now());
            array.push({
              x: rect.x,
              y: videoHeight - rect.y,
              milliseconds: Date.now(),
            });

            localStorage.setItem("array", JSON.stringify(array));
            // localStorage.setItem("arrayTime", JSON.stringify(arrayTime));

            context.strokeStyle = rect.color;

            context.strokeRect(rect.x, rect.y, rect.width, rect.height);
            context.font = "11px Helvetica";
            context.fillStyle = "#fff";
            context.fillText(
              "x: " + rect.x.toFixed(2),
              rect.x + rect.width + 5,
              rect.y + 11
            );
            context.fillText(
              "y: " + (videoHeight - rect.y).toFixed(2),
              rect.x + rect.width + 5,
              rect.y + 22
            );
            // context.fillText(
            //   "color: " + rect.color,
            //   rect.x + rect.width + 5,
            //   rect.y + 36
            // );
          });

          // var layout = {
          //   width: 700,
          //   height: videoHeight,
          //   xaxis: { range: [0.2, 0.9] },
          //   yaxis: { range: [0.25, 1.7] },
          //   plot_bgcolor: "#000",
          //   paper_bgcolor: "#000",
          //   color: "#fff",
          // };
          // TESTER = document.getElementById("tester");

          // Plotly.newPlot(
          //   TESTER,
          //   [
          //     {
          //       x: xArray,
          //       y: yArray,
          //       type: "scatter",
          //       mode: "markers",
          //       marker: {
          //         size: 5,
          //         color: "#5efa0a",
          //       },
          //     },
          //   ],
          //   layout,

          //   {
          //     margin: { t: 0 },
          //   }
          // );
        });
      };
      const stopTracking = () => {
        const trackingTask = tracking.track("#videoPlayer", tracker);
        trackingTask.stop();
      };
      // window.onload = function () {};
    </script>
  </body>
</html>
